# apparmor.d - Full set of apparmor profiles
# Copyright (C) 2023-2024 Alexandre Pujol <alexandre@pujol.io>
# Copyright (C) 2024 Besanon <m231009ts@mailfence.com>
# SPDX-License-Identifier: GPL-2.0-only

abi <abi/4.0>,

include <tunables/global>

@{exec_pathtz8o} = @{bin}/opensnitch-ui
#profile opensnitchd-ui @{exec_pathtz8o} flags=(attach_disconnected, complain) {
profile opensnitchd-ui @{exec_pathtz8o} {
  include <abstractions/base>
  include <abstractions/bus-accessibility>
  include <abstractions/consoles>
  include <abstractions/python>
  include <abstractions/fonts>
  include <abstractions/fontconfig-cache-read>
  include <abstractions/nameservice-strict>
  include <abstractions/graphics>
#  include <abstractions/wayland>
#  include <abstractions/X-strict>

  capability bpf,
  capability mknod,
  capability net_admin,
  capability net_raw,
  capability perfmon,
  capability setpcap,
  capability dac_override,
  capability dac_read_search,
  capability sys_admin,
  capability sys_ptrace,
  capability sys_resource,
  
  ptrace read,

  network inet raw,
  network inet6 raw,
  network netlink raw,
  network inet stream,
  network inet6 stream,
  network inet dgram,
  network inet6 dgram,
  network inet raw,
  network inet6 raw,
  network netlink raw,
  network packet dgram,

  signal (receive) peer=lxqt-session,

  @{exec_pathtz8o} mr,

  @{bin}/xdg-open rPx,

  @{bin}/ 			  r,
  @{bin}/alts                     rix,
  @{bin}/opensnitch                     rPx,
  @{bin}/ebtables-legacy          rix,
  @{bin}/ebtables-legacy-restore  rix,
  @{bin}/false                    rix,
  @{bin}/ipset                    rix,
  @{bin}/ldconfig 		  rix,
  @{bin}/mount 			  rix,
  @{bin}/xtables-legacy-multi     rix, # rpx alt
  @{bin}/xtables-nft-multi        rix, # rpx alt - neu: mix???
#  @{bin}/kmod                  rCx -> kmod,
#  @{sbin}/sysctl               rCx -> sysctl,

  / r,

  /usr/local/lib/python3.10/dist-packages/ r,

  /usr/lib/systemd/systemd-timesyncd r,
  @{bin}/NetworkManager r,
  @{bin}/pacman r,
  /usr/lib/firefox/firefox r,

  /usr/share/libalternatives/ r,
  /usr/share/libalternatives/ebtables*/{,*} r,
  /usr/share/libalternatives/ip{,4,6}tables*/{,*} r,
  /usr/share/icons/hicolor/index.theme r,
  /usr/share/applications/{,**} r,
  /usr/share/hwdata/pnp.ids r,
  /usr/share/icons/{,**} r,

  /etc/iproute2/group r,
  /etc/iproute2/rt_realms r,
  /etc/machine-id r,
  /etc/opensnitchd/rules/ r,
  /etc/opensnitchd/*.json r,
  owner /etc/opensnitchd/ r,
  owner /etc/opensnitchd/{,**} rw,

  /var/lib/ebtables/lock rwk,

  owner /var/log/opensnitchd.log rw,

  /opt/brave-bin/brave r,

  owner @{user_config_dirs}/autostart/opensnitch_ui.desktop rw,
  owner @{user_config_dirs}/opensnitch/#@{int} rwk,
  owner @{user_config_dirs}/opensnitch/settings.conf rwk,
  owner @{user_config_dirs}/opensnitch/actions/ r,
  owner @{user_config_dirs}/opensnitch/settings.conf.lock rwk,
  owner @{user_config_dirs}/opensnitch/settings.conf.@{rand6} rwk,
  owner @{user_config_dirs}/opensnitch/settings.conf.@{rand6} rwkl -> @{user_config_dirs}/opensnitch/#@{int},
  owner @{user_config_dirs}/QtProject.conf r,

  owner @{user_share_dirs}/sddm/wayland-session.log w,
  owner @{user_share_dirs}/sddm/xorg-session.log w,
  owner @{user_share_dirs}/applications/ r,
  owner @{user_share_dirs}/applications/*.desktop r,

  owner /tmp/osui.sock rwk,
  	/tmp/osui.sock rwk,

  @{run}/xtables.lock rwk,
  owner @{run}/user/@{uid}/opensnitch/ rw,
  owner @{run}/user/@{uid}/opensnitch/.@{rand6}/ rw,
  owner @{run}/user/@{uid}/opensnitch/.@{rand6}/s rw,
  owner @{run}/user/@{uid}/opensnitch/io.github.evilsocket.opensnitch rw, 

  owner @{PROC}/ r,
 	@{PROC}/version r,
        @{PROC}/sys/kernel/modprobe r,
  owner @{PROC}/sys/kernel/osrelease r,
  owner @{PROC}/sys/kernel/hostname r,
        @{PROC}/sys/net/ipv{4,6}/ip_forward rw,
	@{PROC}/@{pid}/fd/ r,
  owner @{PROC}/@{pid}/fd/ r,
	@{PROC}/@{pid}/cgroup r,
  owner @{PROC}/@{pid}/cgroup r,
	@{PROC}/@{pid}/cmdline r,
  owner @{PROC}/@{pid}/cmdline r,
	@{PROC}/@{pid}/comm r,
  owner @{PROC}/@{pid}/comm r,
	@{PROC}/@{pid}/environ r,
  owner @{PROC}/@{pid}/environ r,
	@{PROC}/@{pid}/stat r,
  owner @{PROC}/@{pid}/stat r,
	@{PROC}/@{pid}/mem r,
  owner @{PROC}/@{pid}/mounts r,
	@{PROC}/@{pid}/mountinfo r,
  owner @{PROC}/@{pids}/net/ip_tables_names r,
        @{PROC}/sys/net/core/somaxconn r,
	@{PROC}/kallsyms r,
	@{PROC}/sys/kernel/osrelease r,
  owner @{PROC}/@{pid}/net/udp r,
  owner @{PROC}/@{pid}/net/tcp r,

  @{sys}/devices/@{pci}/vendor r,
  @{sys}/devices/@{pci}/vice r,
  @{sys}/devices/@{pci}/uevent r,
  @{sys}/devices/@{pci}/revision r,
  @{sys}/devices/@{pci}/subsystem_vendor r,
  @{sys}/devices/@{pci}/subsystem_device r,
  @{sys}/devices/@{pci}/uevent r,
  @{sys}/devices/@{pci}/revision r,
  @{sys}/devices/@{pci}/vendor r,
  @{sys}/devices/@{pci}/vice r,
  @{sys}/devices/@{pci}/subsystem_vendor r,
  @{sys}/devices/@{pci}/subsystem_device r,
  @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/session-@{u8}.scope/cpu.max r,

  /dev/dri/renderD128 rw,
  owner /dev/tty@{u8} rw,
  owner /dev/shm/wlroots-@{rand6} rw,

  profile kmod flags=(attach_disconnected) {
    include <abstractions/base>
    include <abstractions/app/kmod>

    capability sys_module,

    @{sys}/module/compression r,
    @{sys}/module/*/initstate r,

    include if exists <local/opensnitch_kmod>
  }

  profile sysctl {
    include <abstractions/base>
    include <abstractions/consoles>
    capability net_admin,
    @{sbin}/sysctl mr,
    @{PROC}/sys/net/ipv{4,6}/** rw,
    include if exists <local/opensnitch_sysctl>
  }

  include if exists <local/opensnitch>
}

# vim:syntax=apparmor
